<!DOCTYPE html>
<html lang="en" class="bg-baseCrimson-100">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap');
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home</title>
    <link rel="icon" href="img/favicon.png">
    <!-- <link rel="stylesheet" href="css/picnic.min.css"> -->
    <!-- <link rel="stylesheet" href="css/dist/main.css"> -->
    <!-- <link rel="stylesheet" href="css/font.css"> -->
    <link href="./output.css" rel="stylesheet">
</head>

<body class="w-full h-42 overflow-y-scroll no-scrollbar">
    <!-- Game Area -->
    <div class="game-area overflow-hidden h-screen" id="game-area" hidden></div>
    <div class="pause-menu" id="pause-menu" hidden>
        <div class="paused-title">Paused</div>
        <div class="button-list">
            <div class="pausebutton continue" id="pausebtn-continue">
                <div class="inner">Continue</div>
            </div>
            <div class="pausebutton retry" id="pausebtn-retry">
                <div class="inner">Retry</div>
            </div>
            <div class="pausebutton quit" id="pausebtn-quit">
                <div class="inner">Quit</div>
            </div>
        </div>
    </div>
    <!-- Nav Bar -->
    <nav id="main-nav" class="fixed top-0 left-0 right-0 z-50 bg-baseCrimson-64 backdrop-blur-lg">
        <div class="bg-secondaryCrimson-12">
            <div class="flex items-center justify-between px-16px py-8px">
                <!-- Left Group: Logo, Navigation Links -->
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-24px font-bold text-primaryCrimson-100 mr-2">weboss!</a>
                    <a href="new.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">New</a>
                    <a href="hot.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">Popular</a>
                    <a href="browse.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">Browse</a>
                </div>
                <!-- Center Group: Search Box -->
                <div class="flex items-center flex-1 mx-16px">
                    <form action="search.html" class="flex items-center flex-1">
                        <input type="text" name="q" placeholder="Search or enter ID" class="flex-grow h-10 px-3 text-12px border-none bg-baseCrimson-100 text-primaryCrimson-100 font-medium placeholder-secondaryCrimson-32 rounded-l-12px focus:outline-none focus:ring-0" />
                        <button type="submit" class="h-10 w-10 border-none bg-secondaryCrimson-12 hover:bg-secondaryCrimson-32 text-secondaryCrimson-100 font-bold px-3 rounded-r-12px flex items-center justify-center">
                            <img src="/img/search.svg" alt="Search" class="w-5 h-5 text-secondaryCrimson-100" />
                        </button>
                    </form>
                </div>

                <!-- Right Group: Action Links -->
                <div class="flex items-center space-x-4">
                    <a href="liked.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">Favorites</a>
                    <a href="faq.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">FAQ</a>
                    <a href="settings.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-8px px-16px rounded-12px">Settings</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Page -->
    <main class="main-page flex flex-col w-full mt-80px px-16px max-w-full sm:max-w-screen-sm md:max-w-screen-md lg:max-w-screen-lg xl:max-w-screen-xl mx-auto" id="main-page">
        <div class="site-notice-container">
            <div class="site-notice bg-secondaryCrimson-32 text-baseCrimson-100 p-16px font-medium rounded-12px text-16px">
                Note: This site is still in-development... Expect bugs --
                Forked from
                <a href="https://github.com/111116/webosu" class="text-baseCrimson-100 hover:text-white-100 underline">
                    github.com/111116/webosu
                </a>
                with scripts from
                <a href="https://github.com/BlaNKtext/webosu" class="text-baseCrimson-100 hover:text-white-100 underline">
                    github.com/BlaNKtext/webosu
                </a>
            </div>
        </div>
    </main>
    <!-- Index Areas -->
    <div class="my-24px max-w-full sm:max-w-screen-sm md:max-w-screen-md lg:max-w-screen-lg xl:max-w-screen-xl mx-auto">
        <!-- Popular Beatmaps -->
        <div class="index-area rounded-16px bg-white shadow-md p-4 mb-4">
            <div class="flex justify-between items-end">
                <h2 class="text-24px font-semiBold text-primaryCrimson-100">Popular beatmaps</h2>
                <a href="hot.html" class="text-accentCrimson-100 hover:underline text-16px">See more Popular Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16px bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-hot"></div>
        </div>

        <!-- Previously Played -->
        <div class="index-area rounded-16px bg-white shadow-md p-4 mb-4">
            <div class="flex justify-between items-end">
                <h2 class="text-24px font-semiBold text-primaryCrimson-100">Previously Played</h2>
                <a href="history.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16px">See your play history</a>
            </div>
            <div class="h-1 w-full rounded-16px bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-history"></div>
        </div>

        <!-- Favorited Beatmaps -->
        <div class="index-area rounded-16px bg-white shadow-md p-4 mb-4">
            <div class="flex justify-between items-end">
                <h2 class="text-24px font-semiBold text-primaryCrimson-100">Favorited Beatmaps</h2>
                <a href="liked.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16px">See all favorited Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16px bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-liked"></div>
        </div>

        <!-- Latest Beatmaps -->
        <div class="index-area rounded-16px bg-white shadow-md p-4 mb-4">
            <div class="flex justify-between items-end">
                <h2 class="text-24px font-semiBold text-primaryCrimson-100">Latest Beatmaps</h2>
                <a href="new.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16px">See all latest Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16px bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-new"></div>
        </div>

        <!-- Random Beatmaps -->
        <div class="index-area rounded-16px bg-white shadow-md p-4 mb-4">
            <div class="flex justify-between items-end">
                <h2 class="text-24px font-semiBold text-primaryCrimson-100">Random Beatmaps</h2>
                <a onclick="genRandomList()" class="text-accentCrimson-100 hover:underline align-text-bottom cursor-pointer text-16px">
                    Randomize
                </a>
            </div>
            <div class="h-1 w-full rounded-16px bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-random"></div>
        </div>
    </div>

    <!-- Beatmap Boxes -->


    <!-- Loader Progress -->
    <div id="loader-progress" class="fixed bottom-0 left-0 z-50 ml-16px mb-16px bg-baseCrimson-64 rounded-12px w-256px">
        <div class="bg-secondaryCrimson-12 backdrop-blur-lg p-16px rounded-12px space-y-2">
            <div class="text-center text-primaryCrimson-100 text-14px font-bold mb-2">Status - Download</div>
            <div class="flex justify-between items-center space-x-2 text-secondaryCrimson-100 progress-item" id="script-progress">
                <span class="font-medium text-12px">Scripts</span>
                <div class="circle animate-pulse rounded-full size-4 bg-secondaryCrimson-12"></div>
            </div>
            <div class="flex justify-between items-center space-x-2 text-secondaryCrimson-100 progress-item" id="skin-progress">
                <span class="font-medium text-12px">Skin</span>
                <div class="circle animate-pulse rounded-full size-4 bg-secondaryCrimson-12"></div>
            </div>
            <div class="flex justify-between items-center space-x-2 text-secondaryCrimson-100 progress-item" id="sound-progress">
                <span class="font-medium text-12px">Hitsounds</span>
                <div class="circle animate-pulse rounded-full size-4 bg-secondaryCrimson-12"></div>
            </div>
            <div class="mt-2">
                <!-- Add download progress bar here -->
                <div id="statuslines" class="max-h-80px overflow-y-auto">
                    <!-- Download progress bars will be added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Loader States Utility
        const LoaderStates = {

            markAsFinished(elementId, isSuccess = true) {
                const progressItem = document.getElementById(elementId);
                if (!progressItem) return;

                const circle = progressItem.querySelector('.circle');
                if (!circle) return;

                circle.classList.remove('animate-pulse', 'bg-secondaryCrimson-12', 'size-4');

                if (isSuccess) {
                    circle.classList.add('bg-secondaryCrimson-100', 'size-4');
                } else {
                    circle.classList.add('bg-accentCrimson-100', 'size-4');
                }
            },

            // New method to check and update loader states based on body classes
            updateLoaderStates() {
                const bodyClasses = document.body.classList;
                const progressItems = {
                    'script-ready': 'script-progress',
                    'skin-ready': 'skin-progress',
                    'sound-ready': 'sound-progress'
                };

                Object.entries(progressItems).forEach(([bodyClass, progressId]) => {
                    if (bodyClasses.contains(bodyClass)) {
                        this.markAsFinished(progressId);
                    }
                });
            }
        };

        // Global access to markAsFinished
        window.markAsFinished = LoaderStates.markAsFinished.bind(LoaderStates);

        // Add MutationObserver to watch for body class changes
        const bodyObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    LoaderStates.updateLoaderStates();
                }
            });
        });

        // Start observing the body element
        bodyObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ['class']
        });

        // Initial check in case classes are already present
        document.addEventListener('DOMContentLoaded', () => {
            LoaderStates.updateLoaderStates();
        });

        // Optional: Error Handling for Game Initialization
        window.addEventListener('error', (event) => {
            console.error('Unhandled error during game initialization:', event.error);

            // Mark specific progress items as failed if needed
            if (event.filename.includes('initgame.js')) {
                markAsFinished('script-progress', false);
                markAsFinished('skin-progress', false);
                markAsFinished('sound-progress', false);
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-secondaryCrimson-12 pb-40px p-16px">
        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 text-center">
            <span class="text-secondaryCrimson-100">
                Beatmap Mirror
                <a href="https://catboy.best/" class="text-accentCrimson-100 hover:text-accentCrimson-80 hover:underline">Mino</a>
            </span>
            <span class="text-secondaryCrimson-100">
                Source code:
                <a href="https://github.com/PopCat19/weboss" class="text-accentCrimson-100 hover:text-accentCrimson-80 hover:underline">Github</a>
            </span>
        </div>
    </footer>

    <!-- Beatmap Index Scripts -->
    <script src="js/launchgame.js"></script>
    <script src="js/downloader.js"></script>
    <script src="js/addbeatmaplist.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/jsloader.js"></script>
    <script src="js/lib/localforage.min.js"></script>
    <script>
        // Recently played
        if (window.localforage) {
            let listHistory = document.getElementById("beatmap-list-history");
            localforage.getItem("playhistory1000", function(err, item) {
                if (err) {
                    listHistory.innerText = "Failed to load your recent plays...";
                    return;
                }
                if (item && item.length) {
                    item = item.reverse();
                    let sid = [];
                    for (let i = 0; i < item.length; i++) {
                        if (item[i].sid) sid.push(item[i].sid);
                    }
                    sid = [...new Set(sid)]; // uniq
                    sid.length = Math.min(sid.length, 6)
                    addBeatmapSids(sid, listHistory)
                } else {
                    listHistory.innerText = "You haven't played any Beatmaps yet!";
                }
            })
        }

        // Get new beatmaps
        console.log("Fetching new beatmaps...");
        addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=0&status=4&mode=0",
            document.getElementById("beatmap-list-new"),
            function(t) {
                console.log("Filtering beatmap:", t);
                return (t.modes & 1) != 0;
            }, 4);
        console.log("New beatmaps fetched and filtered.");

        // Get random beatmaps
        function genRandomList() {
            console.log("Generating random beatmap list...");
            // Wipe Random List
            let list = document.getElementById("beatmap-list-random");
            console.log("Clearing random list element:", list);
            list.innerHTML = ''
            console.log("Random list element cleared.");

            // Re-fill Random List
            let randstart = Math.floor(Math.random() * 10000);
            console.log("Generating random offset:", randstart);
            addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=" + randstart + "&status=4&status=1&mode=0", list,
                function(t) {
                    console.log("Filtering random beatmap:", t);
                    while (list.firstChild) {
                        console.log("Removing child element from random list:", list.firstChild);
                        list.removeChild(list.firstChild);
                    }
                    return (t.modes & 1) != 0;
                }, 4);
            console.log("Random beatmap list generated and filtered.");
        }
        genRandomList();

        // Get hot beatmaps
        addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=0&status=1&status=4&mode=0", document.getElementById(
            "beatmap-list-hot"));

        // Favorite beatmaps
        if (window.localforage) {
            window.localforage.getItem("likedsidset", function(err, val) {
                if (err) {
                    document.getElementById("beatmap-list-liked").innerText =
                        "Failed to load favorites list.";
                    return;
                }
                if (val && val.size) {
                    let listLike = document.getElementById("beatmap-list-liked");
                    let list = Array.from(val);
                    list.length = Math.min(list.length, 6)
                    addBeatmapSids(list, listLike);
                } else {
                    document.getElementById("beatmap-list-liked").innerText =
                        "You haven't favorited any Beatmaps yet Click on the heart in the lower right corner of the Beatmap to save it.";
                }
            });
        } else {
            alert("Oh no, localforage isn't supported on this browser")
        }
    </script>
</body>

</html>