<!DOCTYPE html>
<html lang="en" class="bg-baseCrimson-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home</title>
    <link rel="icon" href="img/favicon.png">
    <!-- <link rel="stylesheet" href="css/picnic.min.css"> -->
    <!-- <link rel="stylesheet" href="css/dist/main.css"> -->
    <!-- <link rel="stylesheet" href="css/font.css"> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
    <link href="./output.css" rel="stylesheet">
</head>

<body class="bg-baseCrimson-100">
    <!-- Game Area -->
    <div class="game-area" id="game-area" hidden></div>
    <div class="pause-menu" id="pause-menu" hidden>
        <div class="paused-title">Paused</div>
        <div class="button-list">
            <div class="pausebutton continue" id="pausebtn-continue">
                <div class="inner">Continue</div>
            </div>
            <div class="pausebutton retry" id="pausebtn-retry">
                <div class="inner">Retry</div>
            </div>
            <div class="pausebutton quit" id="pausebtn-quit">
                <div class="inner">Quit</div>
            </div>
        </div>
    </div>
    <!-- Nav Bar -->
    <nav id="main-nav" class="fixed top-0 left-0 right-0 z-50 bg-transparent backdrop-blur-lg rounded-16 mx-4 mt-4">
        <div class="bg-secondaryCrimson-12 rounded-16 shadow-lg">
            <div class="flex items-center justify-between px-4 py-2">
                <!-- Left Group: Logo, Navigation Links -->
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-24 font-bold text-primaryCrimson-100 mr-2">weboss!</a>
                    <a href="new.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">New</a>
                    <a href="hot.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">Popular</a>
                    <a href="browse.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">Browse</a>
                </div>

                <!-- Center Group: Search Box -->
                <div class="flex items-center">
                    <form action="search.html" class="flex items-center">
                        <input type="text" name="q" placeholder="Search or enter ID" class="w-48 h-10 px-3 text-8 border-none bg-baseCrimson-100 text-primaryCrimson-100 font-medium placeholder-secondaryCrimson-32 rounded-l-16 focus:outline-none focus:ring-0" />
                        <button type="submit" class="h-10 border-none bg-secondaryCrimson-12 hover:bg-secondaryCrimson-32 text-secondaryCrimson-100 font-bold px-3 rounded-r-16 flex items-center justify-center">
                            <img src="/img/search.svg" alt="Search" class="w-5 h-5 text-secondaryCrimson-100" />
                        </button>
                    </form>
                </div>

                <!-- Right Group: Action Links -->
                <div class="flex items-center space-x-4">
                    <a href="liked.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">Favorites</a>
                    <a href="faq.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">FAQ</a>
                    <a href="settings.html" class="bg-secondaryCrimson-12 hover:text-white-100 text-secondaryCrimson-100 font-bold py-2 px-4 rounded-16">Settings</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Page -->
    <main class="main-page flex flex-col w-full mt-24 px-4" id="main-page">
        <div class="site-notice-container">
            <div class="site-notice bg-secondaryCrimson-32 text-baseCrimson-100 p-4 font-medium rounded-16 text-16">
                Note: This site is still in-development... Expect bugs --
                Forked from
                <a href="https://github.com/111116/webosu" class="text-baseCrimson-100 hover:text-white-100 underline">
                    github.com/111116/webosu
                </a>
                with scripts from
                <a href="https://github.com/BlaNKtext/webosu" class="text-baseCrimson-100 hover:text-white-100 underline">
                    github.com/BlaNKtext/webosu
                </a>
            </div>
        </div>
        <!-- <div class="flex w-full my-8 px-2">
        <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12"></div>
    </div> -->
    </main>
    <!-- Index Areas -->
    <div class="space-y-16 mx-4">
        <div class="index-area bg-baseCrimson-100 rounded-16">
            <div class="flex justify-between items-end">
                <h2 class="text-24 font-semiBold text-primaryCrimson-100">Popular beatmaps</h2>
                <a href="hot.html" class="text-accentCrimson-100 hover:underline text-16">See more Popular Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-hot"></div>
        </div>

        <div class="index-area bg-baseCrimson-100 rounded-16">
            <div class="flex justify-between items-end">
                <h2 class="text-24 font-semiBold text-primaryCrimson-100">Previously Played</h2>
                <a href="history.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16">See your play history</a>
            </div>
            <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-history"></div>
        </div>

        <div class="index-area bg-baseCrimson-100 rounded-16">
            <div class="flex justify-between items-end">
                <h2 class="text-24 font-semiBold text-primaryCrimson-100">Favorited Beatmaps</h2>
                <a href="liked.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16">See all favorited Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-liked"></div>
        </div>

        <div class="index-area bg-baseCrimson-100 rounded-16">
            <div class="flex justify-between items-end">
                <h2 class="text-24 font-semiBold text-primaryCrimson-100">Latest Beatmaps</h2>
                <a href="new.html" class="text-accentCrimson-100 hover:underline align-text-bottom text-16">See all latest Beatmaps</a>
            </div>
            <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-new"></div>
        </div>

        <div class="index-area bg-baseCrimson-100 rounded-16">
            <div class="flex justify-between items-end">
                <h2 class="text-24 font-semiBold text-primaryCrimson-100">Random Beatmaps</h2>
                <a onclick="genRandomList()" class="text-accentCrimson-100 hover:underline align-text-bottom cursor-pointer text-16">
                    Randomize
                </a>
            </div>
            <div class="h-1 w-full rounded-16 bg-secondaryCrimson-12 mt-2 mb-4"></div>
            <div class="beatmap-list" id="beatmap-list-random"></div>
        </div>
    </div>
    <!-- Loader Progress -->
    <div class="fixed bottom-4 left-4 z-50" id="statuslines">
        <div class="bg-secondaryCrimson-12 backdrop-blur-lg rounded-16 p-4 space-y-2">
            <div class="flex items-center space-x-2 text-secondaryCrimson-100 progress-item" id="script-progress">
                <span class="font-medium text-14">Scripts</span>
                <div class="spinner animate-spin rounded-full h-4 w-4 border-2 border-primaryCrimson-64 border-t-primaryCrimson-100"></div>
            </div>
            <div class="flex items-center space-x-2 text-secondaryCrimson-100 progress-item" id="skin-progress">
                <span class="font-medium text-14">Skin</span>
                <div class="spinner animate-spin rounded-full h-4 w-4 border-2 border-primaryCrimson-64 border-t-primaryCrimson-100"></div>
            </div>
            <div class="flex items-center space-x-2 text-secondaryCrimson-100 progress-item" id="sound-progress">
                <span class="font-medium text-14">Hitsounds</span>
                <div class="spinner animate-spin rounded-full h-4 w-4 border-2 border-primaryCrimson-64 border-t-primaryCrimson-100"></div>
            </div>
        </div>
    </div>

    <script>
        // Loader States Utility
        const LoaderStates = {
            SUCCESS_ICON: `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
        `,
            ERROR_ICON: `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        `,

            markAsFinished(elementId, isSuccess = true) {
                const progressItem = document.getElementById(elementId);
                if (!progressItem) return;

                const spinner = progressItem.querySelector('.spinner');
                if (!spinner) return;

                spinner.classList.remove('animate-spin', 'border-t-primaryCrimson-100');

                if (isSuccess) {
                    spinner.classList.add('border-green-500');
                    spinner.innerHTML = this.SUCCESS_ICON;
                } else {
                    spinner.classList.add('border-red-500');
                    spinner.innerHTML = this.ERROR_ICON;
                }
            },

            // New method to check and update loader states based on body classes
            updateLoaderStates() {
                const bodyClasses = document.body.classList;
                const progressItems = {
                    'script-ready': 'script-progress',
                    'skin-ready': 'skin-progress',
                    'sound-ready': 'sound-progress'
                };

                Object.entries(progressItems).forEach(([bodyClass, progressId]) => {
                    if (bodyClasses.contains(bodyClass)) {
                        this.markAsFinished(progressId);
                    }
                });
            }
        };

        // Global access to markAsFinished
        window.markAsFinished = LoaderStates.markAsFinished.bind(LoaderStates);

        // Add MutationObserver to watch for body class changes
        const bodyObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    LoaderStates.updateLoaderStates();
                }
            });
        });

        // Start observing the body element
        bodyObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ['class']
        });

        // Initial check in case classes are already present
        document.addEventListener('DOMContentLoaded', () => {
            LoaderStates.updateLoaderStates();
        });

        // Optional: Error Handling for Game Initialization
        window.addEventListener('error', (event) => {
            console.error('Unhandled error during game initialization:', event.error);

            // Mark specific progress items as failed if needed
            if (event.filename.includes('initgame.js')) {
                markAsFinished('script-progress', false);
                markAsFinished('skin-progress', false);
                markAsFinished('sound-progress', false);
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-secondaryCrimson-12 p-4">
        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 text-center">
            <span class="text-secondaryCrimson-100">
                Beatmap Mirror
                <a href="https://catboy.best/" class="text-accentCrimson-100 hover:text-accentCrimson-80 hover:underline">Mino</a>
            </span>
            <span class="text-secondaryCrimson-100">
                Source code:
                <a href="https://github.com/PopCat19/weboss" class="text-accentCrimson-100 hover:text-accentCrimson-80 hover:underline">Github</a>
            </span>
        </div>
    </footer>

    <!-- Beatmap Index Scripts -->
    <script src="js/launchgame.js"></script>
    <script src="js/downloader.js"></script>
    <script src="js/addbeatmaplist.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/jsloader.js"></script>
    <script src="js/lib/localforage.min.js"></script>
    <script>
        // Recently played
        if (window.localforage) {
            let listHistory = document.getElementById("beatmap-list-history");
            localforage.getItem("playhistory1000", function(err, item) {
                if (err) {
                    listHistory.innerText = "Failed to load your recent plays...";
                    return;
                }
                if (item && item.length) {
                    item = item.reverse();
                    let sid = [];
                    for (let i = 0; i < item.length; i++) {
                        if (item[i].sid) sid.push(item[i].sid);
                    }
                    sid = [...new Set(sid)]; // uniq
                    sid.length = Math.min(sid.length, 6)
                    addBeatmapSids(sid, listHistory)
                } else {
                    listHistory.innerText = "You haven't played any Beatmaps yet!";
                }
            })
        }

        // Get new beatmaps
        console.log("Fetching new beatmaps...");
        addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=0&status=4&mode=0",
            document.getElementById("beatmap-list-new"),
            function(t) {
                console.log("Filtering beatmap:", t);
                return (t.modes & 1) != 0;
            }, 4);
        console.log("New beatmaps fetched and filtered.");

        // Get random beatmaps
        function genRandomList() {
            console.log("Generating random beatmap list...");
            // Wipe Random List
            let list = document.getElementById("beatmap-list-random");
            console.log("Clearing random list element:", list);
            list.innerHTML = ''
            console.log("Random list element cleared.");

            // Re-fill Random List
            let randstart = Math.floor(Math.random() * 10000);
            console.log("Generating random offset:", randstart);
            addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=" + randstart + "&status=4&status=1&mode=0", list,
                function(t) {
                    console.log("Filtering random beatmap:", t);
                    while (list.firstChild) {
                        console.log("Removing child element from random list:", list.firstChild);
                        list.removeChild(list.firstChild);
                    }
                    return (t.modes & 1) != 0;
                }, 4);
            console.log("Random beatmap list generated and filtered.");
        }
        genRandomList();

        // Get hot beatmaps
        addBeatmapList("https://catboy.best/api/v2/search?q=&limit=6&offset=0&status=1&status=4&mode=0", document.getElementById(
            "beatmap-list-hot"));

        // Favorite beatmaps
        if (window.localforage) {
            window.localforage.getItem("likedsidset", function(err, val) {
                if (err) {
                    document.getElementById("beatmap-list-liked").innerText =
                        "Failed to load favorites list.";
                    return;
                }
                if (val && val.size) {
                    let listLike = document.getElementById("beatmap-list-liked");
                    let list = Array.from(val);
                    list.length = Math.min(list.length, 6)
                    addBeatmapSids(list, listLike);
                } else {
                    document.getElementById("beatmap-list-liked").innerText =
                        "You haven't favorited any Beatmaps yet Click on the heart in the lower right corner of the Beatmap to save it.";
                }
            });
        } else {
            alert("Oh no, localforage isn't supported on this browser")
        }
    </script>
</body>

</html>